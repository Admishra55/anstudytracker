<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>AN Study Tracker</title>
  <meta name="theme-color" content="#4CAF50">
  <link rel="manifest" href="manifest.json">
  <style>
    :root{--brand:#4CAF50;--dark:#121212;--muted:#666}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:#f7f7f7;color:#111}
    header{position:sticky;top:0;z-index:10;display:flex;align-items:center;gap:10px;padding:12px;background:var(--brand);color:#fff}
    header img{height:40px}
    nav{position:sticky;top:64px;z-index:9;display:flex;background:#333}
    nav button{flex:1;padding:10px;border:0;background:#333;color:#fff;font-weight:600;cursor:pointer}
    nav button.active{background:#4CAF50}
    .screen{display:none;padding:16px}.active-screen{display:block}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
    .span-12{grid-column:span 12}.span-8{grid-column:span 12}.span-6{grid-column:span 12}.span-4{grid-column:span 12}
    @media(min-width:800px){.span-8{grid-column:span 8}.span-6{grid-column:span 6}.span-4{grid-column:span 4}}
    .card{background:#fff;border:1px solid #e6e6e6;border-radius:12px;padding:14px}
    .card h3{margin:4px 0 10px;font-size:16px;text-transform:uppercase;color:#333}
    .muted{color:var(--muted)} .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{padding:8px 12px;border:0;border-radius:8px;background:#4CAF50;color:#fff;cursor:pointer}
    .btn.ghost{background:#eee;color:#111}.btn.warn{background:#ff9800}.btn.danger{background:#f44336}
    input,select,textarea{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;background:#fff;color:#111}
    ul{margin:0;padding:0;list-style:none}
    #taskList li{display:flex;justify-content:space-between;align-items:center;gap:10px;margin:6px 0;padding:10px;border-radius:8px;background:#f2f2f2}
    #taskList .meta{font-size:12px;color:#444} #taskList .strike{text-decoration:line-through;opacity:.7}
    .book-grid{display:grid;gap:12px;grid-template-columns:repeat(2,1fr)}@media(min-width:700px){.book-grid{grid-template-columns:repeat(4,1fr)}}
    .book-card{border:1px solid #e6e6e6;border-radius:12px;padding:14px;background:#fafafa;text-align:center}
    .book-card img{width:64px;height:64px;object-fit:contain;margin-bottom:8px}
    body.dark{background:#121212;color:#eee}
    body.dark .card{background:#1e1e1e;border-color:#2b2b2b}
    body.dark nav{background:#222} body.dark nav button{background:#222;color:#eee} body.dark nav button.active{background:#555}
    body.dark .btn.ghost{background:#2a2a2a;color:#eee} body.dark #taskList li{background:#2a2a2a}
    #focusOverlay{position:fixed;inset:0;background:rgba(0,0,0,.92);color:#fff;display:none;z-index:9999;align-items:center;justify-content:center;flex-direction:column;text-align:center;padding:20px}
    #focusOverlay.show{display:flex}
    #chartWrap{height:220px}#weeklyChart{width:100%;height:200px;display:block}
  </style>
</head>
<body>
  <header>
    <img src="logo_192x192.png" alt="Logo"><h1>AN Study Tracker</h1>
  </header>

  <nav>
    <button id="nav-dashboard" class="active" onclick="showScreen('dashboard')">Dashboard</button>
    <button id="nav-planner" onclick="showScreen('planner')">Planner</button>
    <button id="nav-focus" onclick="showScreen('focus')">Focus</button>
    <button id="nav-library" onclick="showScreen('library')">Library</button>
    <button id="nav-settings" onclick="showScreen('settings')">Settings</button>
  </nav>

  <!-- DASHBOARD -->
  <section id="dashboard" class="screen active-screen">
    <div class="grid">
      <div class="card span-8">
        <h3>Today</h3>
        <p>Study Today: <b><span id="todayStudy">0</span></b> min • Streak: <b><span id="streak">0</span></b> days • Pomodoro: <b><span id="pomoCount">0</span></b></p>
        <p class="muted" id="quote">“Small progress each day adds up to big results.”</p>
      </div>
      <div class="card span-4">
        <h3>Totals</h3>
        <p>Total Study Hours: <b><span id="totalHours">0</span></b></p>
        <p>Tasks — Pending: <b><span id="tPending">0</span></b> • Done: <b><span id="tDone">0</span></b></p>
        <div class="row"><button class="btn ghost" onclick="testNotify()">Test Notification</button></div>
      </div>
      <div class="card span-12">
        <h3>Weekly Analytics (Last 7 Days)</h3>
        <div id="chartWrap"><canvas id="weeklyChart"></canvas></div>
        <p class="muted">Bar = hours studied per day</p>
      </div>
      <div class="card span-6">
        <h3>Reminder / Alarm</h3>
        <div class="row">
          <input type="time" id="alarmTime">
          <button class="btn" onclick="setAlarm()">Set Reminder</button>
          <button class="btn ghost" onclick="clearAlarm()">Clear</button>
        </div>
        <p class="muted" id="alarmStatus">No alarm set.</p>
      </div>
      <div class="card span-6">
        <h3>Quick Export</h3>
        <button class="btn" onclick="exportPDF()">Export report (Print → PDF)</button>
      </div>
    </div>
  </section>

  <!-- PLANNER -->
  <section id="planner" class="screen">
    <div class="grid">
      <div class="card span-6">
        <h3>Add Task</h3>
        <div class="row">
          <input id="taskInput" placeholder="Task title…">
          <input id="taskDue" type="date">
          <button class="btn" onclick="addTask()">➕ Add</button>
        </div>
        <ul id="taskList"></ul>
        <div class="row"><button class="btn ghost" onclick="clearDone()">Clear Completed</button></div>
      </div>
      <div class="card span-6">
        <h3>Google Calendar</h3>
        <p class="muted">Task के साथ due date चुनें और Calendar में event जोड़ें।</p>
        <div class="row">
          <input id="gcalTitle" placeholder="Event title e.g. Study Algebra">
          <input id="gcalDate" type="date">
          <input id="gcalStart" type="time" value="18:00">
          <input id="gcalEnd" type="time" value="19:00">
          <button class="btn" onclick="openGCal()">Add to Google Calendar</button>
        </div>
      </div>
    </div>
  </section>

  <!-- FOCUS -->
  <section id="focus" class="screen">
    <div class="grid">
      <div class="card span-8">
        <h3>Stopwatch</h3>
        <p id="timer" style="font-size:36px;font-weight:bold;margin:10px 0">00:00:00</p>
        <div class="row">
          <button class="btn" onclick="startTimer()">Start</button>
          <button class="btn ghost" onclick="stopTimer()">Stop</button>
          <button class="btn" onclick="resetTimer()">Reset</button>
          <button class="btn warn" onclick="toggleFocusOverlay(true)">Focus Mode</button>
        </div>
        <p class="muted">Stop दबाते ही समय Total Hours और आज के summary में जुड़ जाएगा।</p>
      </div>
      <div class="card span-4">
        <h3>Pomodoro</h3>
        <div class="row">
          <label>Study (min)<input id="pomoStudy" type="number" min="1" value="25"></label>
          <label>Break (min)<input id="pomoBreak" type="number" min="1" value="5"></label>
        </div>
        <div class="row">
          <button class="btn" onclick="pomoStart()">Start</button>
          <button class="btn ghost" onclick="pomoPause()">Pause</button>
          <button class="btn danger" onclick="pomoReset()">Reset</button>
        </div>
        <p style="font-size:24px;margin:8px 0"><b id="pomoLabel">Study</b> — <span id="pomoClock">25:00</span></p>
        <p class="muted">हर study phase पूरा होने पर study time auto-log हो जाता है।</p>
      </div>
    </div>
  </section>

  <!-- LIBRARY -->
  <section id="library" class="screen">
    <div class="grid">
      <div class="card span-12">
        <h3>My Books (from /books)</h3>
        <div class="book-grid" id="bookGrid"></div>
        <p class="muted">नई किताब जोड़ने के लिए GitHub repo में <code>books/</code> folder में PDF upload करें—यहाँ अपने-आप दिख जाएगा।</p>
      </div>
      <div class="card span-12">
        <h3>Open Your PDF (from phone)</h3>
        <div class="row"><input type="file" accept="application/pdf" onchange="openLocalPDF(event)"></div>
        <div id="pdfView" style="margin-top:10px"></div>
        <p class="muted">यह local view है—server पर upload नहीं होता।</p>
      </div>
    </div>
  </section>

  <!-- SETTINGS + NOTES -->
  <section id="settings" class="screen">
    <div class="grid">
      <div class="card span-6">
        <h3>Appearance</h3>
        <div class="row"><button class="btn" onclick="toggleTheme()">Toggle Dark/Light</button></div>
        <p class="muted">Theme याद रहती है. App v1.4</p>
      </div>
      <div class="card span-6">
        <h3>Revision & Notes</h3>
        <textarea id="notes" rows="10" placeholder="Write your notes, formulas, revision points..."></textarea>
        <div class="row" style="margin-top:8px">
          <button class="btn" onclick="saveNotes()">Save</button>
          <button class="btn ghost" onclick="loadNotes()">Load</button>
          <button class="btn danger" onclick="clearNotes()">Clear</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Focus Overlay -->
  <div id="focusOverlay">
    <h2>Focus Mode</h2>
    <p>Distraction block ON. Press <b>Esc</b> or Exit.</p>
    <div class="row" style="justify-content:center;margin-top:8px">
      <button class="btn" onclick="toggleFocusOverlay(false)">Exit Focus</button>
    </div>
  </div>

  <script>
  'use strict';
  // ---------- helpers ----------
  const $ = q => document.querySelector(q);
  const $$ = q => Array.from(document.querySelectorAll(q));
  const getStore = (k,d)=>{try{return JSON.parse(localStorage.getItem(k)) ?? d}catch{return d}};
  const setStore = (k,v)=>localStorage.setItem(k,JSON.stringify(v));
  const ymd = d=>{const x=new Date(d);const m=String(x.getMonth()+1).padStart(2,'0');const dd=String(x.getDate()).padStart(2,'0');return `${x.getFullYear()}-${m}-${dd}`};
  const today = ()=>ymd(new Date());

  // ---------- nav/theme ----------
  function showScreen(id){ $$('.screen').forEach(s=>s.classList.remove('active-screen')); $('#'+id).classList.add('active-screen'); $$('nav button').forEach(b=>b.classList.remove('active')); const nb=$('#nav-'+id); if(nb) nb.classList.add('active'); }
  function toggleTheme(){ document.body.classList.toggle('dark'); setStore('theme',document.body.classList.contains('dark')?'dark':'light'); }
  (function(){ if(getStore('theme','light')==='dark') document.body.classList.add('dark') })();

  // ---------- tasks ----------
  document.addEventListener('DOMContentLoaded', loadTasks);
  function addTask(){ const text=$('#taskInput').value.trim(); if(!text) return; const due=$('#taskDue').value||null; const tasks=getStore('tasks',[]); tasks.push({text,due,done:false}); setStore('tasks',tasks); $('#taskInput').value=''; renderTaskList(tasks); updateDashboardStats(); }
  function toggleTask(i){ const t=getStore('tasks',[]); t[i].done=!t[i].done; setStore('tasks',t); renderTaskList(t); updateDashboardStats(); }
  function deleteTask(i){ const t=getStore('tasks',[]); t.splice(i,1); setStore('tasks',t); renderTaskList(t); updateDashboardStats(); }
  function clearDone(){ const t=getStore('tasks',[]).filter(x=>!x.done); setStore('tasks',t); renderTaskList(t); updateDashboardStats(); }
  function renderTaskList(tasks){ const ul=$('#taskList'); ul.innerHTML=''; if(!tasks.length){ ul.innerHTML='<li class="muted">No tasks yet.</li>'; return; } tasks.forEach((t,i)=>{ const li=document.createElement('li'); li.innerHTML=`<div><input type="checkbox" ${t.done?'checked':''} onchange="toggleTask(${i})"></div><div class="grow ${t.done?'strike':''}"><div><b>${t.text}</b></div><div class="meta">Due: ${t.due||'—'}</div></div><div class="row" style="gap:6px">${t.due?`<button class="btn ghost" onclick="gcalFromTask(${i})">Calendar</button>`:''}<button class="btn danger" onclick="deleteTask(${i})">Delete</button></div>`; ul.appendChild(li); }); }
  function loadTasks(){ renderTaskList(getStore('tasks',[])); updateDashboardStats(); updateTodayAndStreak(); updateTotalHours(); renderWeeklyChart(); updatePomoCount(); }

  // ---------- Google Calendar ----------
  function toGoogleDate(d,t){ const [hh='09',mm='00']=String(t||'09:00').split(':'); const iso=new Date(`${d}T${hh}:${mm}:00`).toISOString().replace(/[-:]/g,''); return iso.slice(0,15)+'Z'; }
  function gcalURL({title,details='',date,start='18:00',end='19:00'}){ const p=new URLSearchParams({action:'TEMPLATE',text:title,details}); if(date) p.set('dates',`${toGoogleDate(date,start)}/${toGoogleDate(date,end)}`); return 'https://calendar.google.com/calendar/render?'+p.toString(); }
  function gcalFromTask(i){ const t=getStore('tasks',[])[i]; if(!t?.due) return; window.open(gcalURL({title:`[Study] ${t.text}`,date:t.due}),'_blank'); }
  function openGCal(){ const title=$('#gcalTitle').value||'Study'; const date=$('#gcalDate').value; if(!date) return alert('Choose a date'); const start=$('#gcalStart').value||'18:00'; const end=$('#gcalEnd').value||'19:00'; window.open(gcalURL({title,date,start,end}),'_blank'); }

  // ---------- stopwatch ----------
  let timerInterval=null, seconds=0;
  function updateDisplay(){ const h=String(Math.floor(seconds/3600)).padStart(2,'0'); const m=String(Math.floor((seconds%3600)/60)).padStart(2,'0'); const s=String(seconds%60).padStart(2,'0'); $('#timer').textContent=`${h}:${m}:${s}`; }
  function startTimer(){ if(timerInterval) return; timerInterval=setInterval(()=>{ seconds++; updateDisplay(); },1000); }
  function stopTimer(){ if(!timerInterval) return; clearInterval(timerInterval); timerInterval=null; if(seconds>0){ addStudySeconds(seconds); seconds=0; updateDisplay(); } }
  function resetTimer(){ stopTimer(); seconds=0; updateDisplay(); }

  // ---------- study log / analytics ----------
  function addStudySeconds(sec){ const total=(getStore('totalSeconds',0)||0)+sec; setStore('totalSeconds',total); updateTotalHours(); const map=getStore('dayTotals',{}); const d=today(); map[d]=(map[d]||0)+sec; setStore('dayTotals',map); updateTodayAndStreak(); renderWeeklyChart(); }
  function updateTotalHours(){ const hrs=(getStore('totalSeconds',0)||0)/3600; $('#totalHours').textContent=hrs.toFixed(2); }
  function updateDashboardStats(){ const tasks=getStore('tasks',[]); const done=tasks.filter(t=>t.done).length; const pend=tasks.length-done; $('#tDone').textContent=done; $('#tPending').textContent=pend; }
  function updateTodayAndStreak(){ const map=getStore('dayTotals',{}); const d=today(); const todayMin=Math.floor((map[d]||0)/60); $('#todayStudy').textContent=todayMin; let streak=0; const cur=new Date(); while(true){ const k=ymd(cur); if((map[k]||0)>=3600){ streak++; cur.setDate(cur.getDate()-1);} else break; } setStore('streak',streak); $('#streak').textContent=streak; }

  // ---------- notes ----------
  function saveNotes(){ setStore('notes',$('#notes').value); alert('Notes saved'); }
  function loadNotes(){ $('#notes').value=getStore('notes',''); }
  function clearNotes(){ if(confirm('Delete all notes?')){ setStore('notes',''); $('#notes').value=''; } }

  // ---------- PDF export ----------
  function exportPDF(){ const tasks=getStore('tasks',[]); const dayTotals=getStore('dayTotals',{}); const totalH=((getStore('totalSeconds',0)||0)/3600).toFixed(2); const w=window.open('','_blank'); const rowsTasks=tasks.map(t=>`<tr><td>${t.text}</td><td>${t.due||'-'}</td><td>${t.done?'Done':'Open'}</td></tr>`).join(''); const rowsDays=Object.keys(dayTotals).sort().map(k=>`<tr><td>${k}</td><td>${(dayTotals[k]/3600).toFixed(2)} h</td></tr>`).join(''); w.document.write(`<!doctype html><html><head><title>AN Study Report</title><style>body{font-family:Arial;margin:16px}table{border-collapse:collapse;width:100%}td,th{border:1px solid #ccc;padding:6px}h1{margin:6px 0}</style></head><body><h1>AN Study Tracker – Report</h1><p><b>Total Hours:</b> ${totalH} &nbsp; | &nbsp; <b>Streak:</b> ${getStore('streak',0)}</p><h3>Tasks</h3><table><tr><th>Task</th><th>Due</th><th>Status</th></tr>${rowsTasks||'<tr><td colspan=3>No tasks</td></tr>'}</table><h3>Daily Study</h3><table><tr><th>Date</th><th>Hours</th></tr>${rowsDays||'<tr><td colspan=2>No data</td></tr>'}</table></body></html>`); w.document.close(); w.focus(); w.print(); }

  // ---------- notifications / alarm ----------
  async function ensureNotify(){ if(!('Notification' in window)) return false; if(Notification.permission==='granted') return true; if(Notification.permission!=='denied'){ const p=await Notification.requestPermission(); return p==='granted'; } return false; }
  function testNotify(){ ensureNotify().then(ok=>{ if(ok) new Notification('🔔 Notifications enabled'); else alert('Notifications not supported / permission denied'); }); }
  let alarmTimeout=null;
  function setAlarm(){ const t=$('#alarmTime').value; if(!t) return alert('Choose a time'); clearAlarm(); const now=new Date(); const [hh,mm]=t.split(':').map(Number); const at=new Date(); at.setHours(hh,mm,0,0); if(at<now) at.setDate(at.getDate()+1); const ms=at-now; setStore('alarmAt',at.toISOString()); $('#alarmStatus').textContent='Alarm set for '+at.toLocaleTimeString(); alarmTimeout=setTimeout(ring,ms); }
  function ring(){ const msg='⏰ Study Reminder! Time to focus.'; try{ if('Notification' in window && Notification.permission==='granted'){ new Notification(msg); } }catch{} const a=new Audio(); a.src='data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAZGF0YQAAAAA='; a.play?.(); alert(msg); clearAlarm(); }
  function clearAlarm(){ if(alarmTimeout) clearTimeout(alarmTimeout); alarmTimeout=null; setStore('alarmAt',null); $('#alarmStatus').textContent='No alarm set.' }
  (function(){ const iso=getStore('alarmAt',null); if(!iso) return; const at=new Date(iso); const now=new Date(); if(at>now){ $('#alarmStatus').textContent='Alarm set for '+at.toLocaleTimeString(); alarmTimeout=setTimeout(ring,at-now); } else { setStore('alarmAt',null);} })();
  document.addEventListener('click',()=>{ ensureNotify(); },{once:true});

  // ---------- weekly chart ----------
  function getLast7(){ const res=[]; const map=getStore('dayTotals',{}); const d=new Date(); for(let i=6;i>=0;i--){ const x=new Date(d); x.setDate(d.getDate()-i); const key=ymd(x); res.push({key,label:`${x.getDate()}/${x.getMonth()+1}`,sec:map[key]||0}); } return res; }
  function renderWeeklyChart(){ const c=$('#weeklyChart'); if(!c) return; const ctx=c.getContext('2d'); const dpr=window.devicePixelRatio||1; const W=c.clientWidth||c.parentElement.clientWidth; const H=c.clientHeight||200; c.width=W*dpr; c.height=H*dpr; ctx.setTransform(dpr,0,0,dpr,0,0); ctx.clearRect(0,0,W,H); const data=getLast7(); const maxSec=Math.max(3600,...data.map(d=>d.sec)); const pad=24; const base=H-28; const barW=(W-pad*2)/(data.length*1.4); const gap=barW*0.4; ctx.font='12px Arial'; ctx.textAlign='center'; ctx.textBaseline='middle'; data.forEach((d,i)=>{ const x=pad+i*(barW+gap)+gap/2; const h=Math.round(((d.sec)/maxSec)*(H-70)); const y=base-h; ctx.fillStyle=getComputedStyle(document.body).getPropertyValue('--brand')||'#4CAF50'; ctx.fillRect(x,y,barW,h); ctx.fillStyle=getComputedStyle(document.body).color; ctx.fillText(d.label,x+barW/2,H-12); ctx.fillText((d.sec/3600).toFixed(1),x+barW/2,y-10); }); ctx.strokeStyle='#bbb'; ctx.beginPath(); ctx.moveTo(pad,base+0.5); ctx.lineTo(W-pad,base+0.5); ctx.stroke(); }
  window.addEventListener('resize',renderWeeklyChart);

  // ---------- pomodoro ----------
  let pomoTimer=null,pomoRemain=0,pomoMode='study',pomoLastStudySec=0;
  const fmtMMSS=s=>`${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
  function getPomoSetting(){ return {study:parseInt($('#pomoStudy').value||25),brk:parseInt($('#pomoBreak').value||5)} }
  function updatePomoUI(){ $('#pomoLabel').textContent=(pomoMode==='study'?'Study':'Break'); $('#pomoClock').textContent=fmtMMSS(pomoRemain); }
  function logPomoSession(){ addStudySeconds(pomoLastStudySec); const map=getStore('pomoSessions',{}); const d=today(); map[d]=(map[d]||0)+1; setStore('pomoSessions',map); updatePomoCount(); try{ if(Notification.permission==='granted') new Notification('✅ Study block logged'); }catch{} }
  function updatePomoCount(){ const map=getStore('pomoSessions',{}); $('#pomoCount').textContent=map[today()]||0; }
  function startPhase(){ const {study,brk}=getPomoSetting(); pomoRemain=(pomoMode==='study'?study:brk)*60; updatePomoUI(); if(pomoTimer) clearInterval(pomoTimer); pomoTimer=setInterval(()=>{ pomoRemain--; updatePomoUI(); if(pomoRemain<=0){ clearInterval(pomoTimer); pomoTimer=null; if(pomoMode==='study'){ pomoLastStudySec=getPomoSetting().study*60; logPomoSession(); pomoMode='break'; } else { pomoMode='study'; } startPhase(); } },1000); }
  function pomoStart(){ if(!pomoTimer){ pomoMode=(pomoMode||'study'); startPhase(); } }
  function pomoPause(){ if(pomoTimer){ clearInterval(pomoTimer); pomoTimer=null; } }
  function pomoReset(){ if(pomoTimer){ clearInterval(pomoTimer); pomoTimer=null; } pomoMode='study'; pomoRemain=getPomoSetting().study*60; updatePomoUI(); }
  document.addEventListener('DOMContentLoaded',()=>{ pomoRemain=getPomoSetting().study*60; updatePomoUI(); });

  // ---------- books (GitHub API) ----------
  const GH_OWNER='Admishra55';  // <== change if needed
  const GH_REPO='anstudytracker'; // <== change if needed
  const BOOKS_PATH='books';
  async function loadBooks(){
    const grid=$('#bookGrid'); if(!grid) return;
    grid.innerHTML='<p class="muted">Loading books…</p>';
    try{
      const api=`https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/contents/${BOOKS_PATH}`;
      const res=await fetch(api); const items=await res.json();
      const pdfs=(Array.isArray(items)?items:[]).filter(f=>f.type==='file' && /\.pdf$/i.test(f.name));
      if(!pdfs.length){ grid.innerHTML='<p class="muted">No PDFs found in /books.</p>'; return;}
      grid.innerHTML='';
      pdfs.forEach(f=>{
        const title=f.name.replace(/\.pdf$/i,'');
        const card=document.createElement('div');
        card.className='book-card';
        card.innerHTML=`<img src="logo_192x192.png" alt="PDF"><div><b>${title}</b></div><div class="row" style="justify-content:center;margin-top:8px"><a class="btn" href="${f.download_url}" target="_blank" rel="noopener">📖 Open</a></div>`;
        grid.appendChild(card);
      });
    }catch(e){ console.error(e); grid.innerHTML='<p class="muted">Failed to load books.</p>'; }
  }

  // ---------- open local pdf ----------
  function openLocalPDF(e){ const file=e.target.files && e.target.files[0]; if(!file || file.type!=='application/pdf') return alert('Please choose a PDF file'); const url=URL.createObjectURL(file); $('#pdfView').innerHTML=`<embed src="${url}" type="application/pdf" width="100%" height="500px">`; }

  // ---------- focus overlay ----------
  function toggleFocusOverlay(show){ const el=$('#focusOverlay'); if(show===false){ el.classList.remove('show'); document.exitFullscreen?.(); return; } el.classList.add('show'); el.requestFullscreen?.(); }
  document.addEventListener('keydown',e=>{ if(e.key==='Escape') toggleFocusOverlay(false) });

  // ---------- init ----------
  window.addEventListener('load',()=>{ loadNotes(); updateDashboardStats(); updateTodayAndStreak(); updateTotalHours(); renderWeeklyChart(); updatePomoCount(); loadBooks(); if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js').catch(()=>{}); }});
  </script>

  <!-- fallback SW register -->
  <script> if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js').catch(()=>{}); } </script>
</body>
</html>

